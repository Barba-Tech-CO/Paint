# M√ìDULO DE EXTRA√á√ÉO DE PDF - EXTRACAO_PDF_MODULE

Este m√≥dulo gerencia o upload e extra√ß√£o de dados de materiais a partir de arquivos PDF, com armazenamento em **Cloudflare R2** e processamento autom√°tico de or√ßamentos e listas de materiais. O sistema suporta apenas arquivos com pre√ßos em **USD ($)** e todas as mensagens s√£o em **ingl√™s**.

## üîí SEGURAN√áA E CONTROLE DE ACESSO

### Sistema de Autentica√ß√£o e Autoriza√ß√£o

- **Autentica√ß√£o obrigat√≥ria** via Laravel Sanctum (Bearer Token)
- **Middleware de seguran√ßa** espec√≠fico para PDFs (`pdf.security`)
- **Pol√≠ticas de autoriza√ß√£o** para controle granular de acesso
- **Isolamento por usu√°rio** garantindo que cada usu√°rio veja apenas seus pr√≥prios arquivos

### Camadas de Seguran√ßa Implementadas

1. **Middleware `auth:sanctum`** - Autentica√ß√£o obrigat√≥ria
2. **Middleware `user.ownership`** - Garantia de ownership de dados
3. **Middleware `pdf.security`** - Valida√ß√£o espec√≠fica de seguran√ßa para PDFs
4. **Pol√≠ticas de autoriza√ß√£o** - Controle fino de permiss√µes por recurso
5. **Global scopes** - Filtros autom√°ticos por usu√°rio em todos os modelos
6. **Valida√ß√£o de FormRequest** - Garantia de que `user_id` seja sempre preenchido

### Garantias de Seguran√ßa

- ‚úÖ **PDFs sempre associados a usu√°rios** - Campo `user_id` obrigat√≥rio (NOT NULL)
- ‚úÖ **Isolamento autom√°tico** - Usu√°rios s√≥ veem seus pr√≥prios arquivos
- ‚úÖ **Valida√ß√£o de ownership** - Verifica√ß√£o em todas as opera√ß√µes CRUD
- ‚úÖ **Logs de seguran√ßa** - Rastreamento de todas as opera√ß√µes cr√≠ticas
- ‚úÖ **Preven√ß√£o de acesso n√£o autorizado** - Bloqueio autom√°tico de tentativas de acesso
- ‚úÖ **Valida√ß√£o de recursos** - Verifica√ß√£o de propriedade antes de opera√ß√µes

## 1. Modelos de Dados e Estrutura da Tabela

### Modelo PdfUpload (Upload de PDF)

**Arquivo:** `app/PdfUpload.php`

**Atributos do Model:**

- `id` (integer, not null) - ID √∫nico do upload
- `user_id` (integer, **NOT NULL**) - **ID do usu√°rio propriet√°rio (obrigat√≥rio)**
- `original_name` (string, not null) - Nome original do arquivo
- `display_name` (string, nullable) - Nome de exibi√ß√£o personalizado
- `file_path` (string, not null) - **Chave R2 do arquivo** (formato: `pdfs/{Y}/{m}/{d}/{uuid}-{nome}.pdf`)
- `r2_url` (string, nullable) - **URL de acesso R2** (tempor√°ria ou p√∫blica via CDN)
- `file_hash` (string, not null, unique) - Hash √∫nico do arquivo
- `status` (string, not null) - Status do processamento (pending, processing, completed, failed)
- `materials_extracted` (integer, not null) - N√∫mero de materiais extra√≠dos
- `extraction_metadata` (array, nullable) - Metadados da extra√ß√£o
- `error_message` (text, nullable) - Mensagem de erro se houver
- `created_at` (timestamp, not null) - Data de upload
- `updated_at` (timestamp, not null) - Data de atualiza√ß√£o

**Estrutura da Tabela `pdf_uploads`:**

```sql
CREATE TABLE pdf_uploads (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL, -- Campo obrigat√≥rio para seguran√ßa
    original_name VARCHAR(255) NOT NULL,
    display_name VARCHAR(255) NULL,
    file_path VARCHAR(255) NOT NULL, -- Chave R2 do arquivo
    r2_url VARCHAR(512) NULL, -- URL de acesso R2
    file_hash VARCHAR(255) NOT NULL UNIQUE,
    status VARCHAR(255) DEFAULT 'pending',
    materials_extracted INT DEFAULT 0,
    extraction_metadata JSON NULL,
    error_message TEXT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

### Modelo ExtractedMaterial (Material Extra√≠do)

**Arquivo:** `app/ExtractedMaterial.php`

**Atributos do Model:**

- `id` (integer, not null) - ID √∫nico do material
- `pdf_upload_id` (integer, not null) - ID do upload de PDF
- `user_id` (integer, **NOT NULL**) - **ID do usu√°rio propriet√°rio (obrigat√≥rio)**
- `brand` (string, not null) - Marca do material
- `description` (string, not null) - Descri√ß√£o do material
- `type` (string, not null) - Tipo do material (padr√£o: 'liquid')
- `unit` (string, not null) - Unidade de medida
- `unit_price` (decimal, not null) - Pre√ßo unit√°rio
- `finish` (string, nullable) - Acabamento do material
- `quality_grade` (string, nullable) - Grau de qualidade
- `category` (string, nullable) - Categoria do material
- `specifications` (array, nullable) - Especifica√ß√µes t√©cnicas
- `line_number` (integer, not null) - N√∫mero da linha no documento
- `created_at` (timestamp, not null) - Data de cria√ß√£o
- `updated_at` (timestamp, not null) - Data de atualiza√ß√£o

**Estrutura da Tabela `extracted_materials`:**

```sql
CREATE TABLE extracted_materials (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    pdf_upload_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL, -- Campo obrigat√≥rio para seguran√ßa
    brand VARCHAR(255) NOT NULL,
    description VARCHAR(255) NOT NULL,
    type VARCHAR(255) DEFAULT 'liquid',
    unit VARCHAR(255) NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    finish VARCHAR(255) NULL,
    quality_grade VARCHAR(255) NULL,
    category VARCHAR(255) NULL,
    specifications JSON NULL,
    line_number INTEGER NOT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    FOREIGN KEY (pdf_upload_id) REFERENCES pdf_uploads(id) ON DELETE CASCADE,
    INDEX idx_pdf_upload (pdf_upload_id),
    INDEX idx_user_id (user_id),
    INDEX idx_brand (brand),
    INDEX idx_category (category)
);
```

## 2. Pol√≠ticas de Autoriza√ß√£o e Seguran√ßa

### 2.1 Pol√≠ticas Implementadas

**PdfUploadPolicy** - Controla acesso aos PDFs:

- `view` - Usu√°rio s√≥ pode ver PDFs que pertencem a ele
- `create` - Usu√°rio autenticado pode criar PDFs
- `update` - Usu√°rio s√≥ pode atualizar PDFs que pertencem a ele
- `delete` - Usu√°rio s√≥ pode excluir PDFs que pertencem a ele

**ExtractedMaterialPolicy** - Controla acesso aos materiais:

- `view` - Usu√°rio s√≥ pode ver materiais que pertencem a ele
- `create` - Usu√°rio autenticado pode criar materiais
- `update` - Usu√°rio s√≥ pode atualizar materiais que pertencem a ele
- `delete` - Usu√°rio s√≥ pode excluir materiais que pertencem a ele

### 2.2 Middleware de Seguran√ßa

**`pdf.security`** - Valida√ß√£o espec√≠fica para opera√ß√µes de PDF:

- Verifica√ß√£o de autentica√ß√£o obrigat√≥ria
- Logs de seguran√ßa para opera√ß√µes cr√≠ticas
- Valida√ß√£o de acesso a recursos antes de opera√ß√µes
- Preven√ß√£o de tentativas de acesso n√£o autorizado

**`user.ownership`** - Garantia de ownership de dados:

- Auto-merge autom√°tico de `user_id` em todas as requisi√ß√µes
- Filtros autom√°ticos por usu√°rio em todas as consultas

### 2.3 Valida√ß√µes de Seguran√ßa

- **Campo `user_id` obrigat√≥rio** em todos os FormRequests
- **Valida√ß√£o autom√°tica** de ownership em todas as opera√ß√µes
- **Global scopes** nos modelos garantindo isolamento por usu√°rio
- **Verifica√ß√£o de propriedade** antes de opera√ß√µes de modifica√ß√£o

## 3. Endpoints da API

### 3.1 Upload de PDF

**T√≠tulo:** Fazer Upload de Arquivo PDF  
**Descri√ß√£o:** Faz upload de um arquivo PDF para extra√ß√£o de materiais

**URL e M√©todo HTTP:** `POST /api/materials/upload`  
**Par√¢metros da Rota:** Nenhum

### 3.2 Listar Uploads

**T√≠tulo:** Listar Uploads de PDF  
**Descri√ß√£o:** Retorna lista paginada de uploads de PDF com status de processamento

**URL e M√©todo HTTP:** `GET /api/materials/uploads`  
**Par√¢metros da Rota:** Nenhum  
**Query Parameters:**

- `status` (string, opcional) - Filtrar por status (pending, processing, completed, failed)
- `limit` (integer, opcional) - N√∫mero de itens por p√°gina (padr√£o: 10)
- `page` (integer, opcional) - N√∫mero da p√°gina (padr√£o: 1)

**Seguran√ßa:** Apenas retorna PDFs do usu√°rio autenticado

### 3.3 Verificar Status

**T√≠tulo:** Verificar Status do Processamento  
**Descri√ß√£o:** Retorna o status e resultados do processamento de um PDF espec√≠fico

**URL e M√©todo HTTP:** `GET /api/materials/status/{pdfUpload}`  
**Par√¢metros da Rota:**

- `pdfUpload` (integer, obrigat√≥rio) - ID do upload de PDF

### 3.4 Atualizar Upload

**T√≠tulo:** Atualizar Dados do Upload  
**Descri√ß√£o:** Atualiza informa√ß√µes de um upload de PDF (como nome de exibi√ß√£o)

**URL e M√©todo HTTP:** `PUT /api/materials/update/{pdfUpload}`  
**Par√¢metros da Rota:**

- `pdfUpload` (integer, obrigat√≥rio) - ID do upload de PDF

### 3.5 Excluir Upload

**T√≠tulo:** Excluir Upload de PDF  
**Descri√ß√£o:** Remove um upload de PDF e todos os materiais extra√≠dos

**URL e M√©todo HTTP:** `DELETE /api/materials/delete/{pdfUpload}`  
**Par√¢metros da Rota:**

- `pdfUpload` (integer, obrigat√≥rio) - ID do upload de PDF

### 3.6 Listar Materiais Extra√≠dos

**T√≠tulo:** Listar Materiais Extra√≠dos  
**Descri√ß√£o:** Retorna lista paginada e filtrada de todos os materiais extra√≠dos dos PDFs

**URL e M√©todo HTTP:** `GET /api/materials/extracted`  
**Par√¢metros da Rota:** Nenhum  
**Query Parameters:**

- `brand` (string, opcional) - Filtrar por marca espec√≠fica (dropdown)
- `ambient` (string, opcional) - Filtrar por ambiente/categoria (dropdown: Interior, Exterior, etc.)
- `finish` (string, opcional) - Filtrar por acabamento (dropdown: Flat, Satin, Semi-Gloss, Gloss)
- `quality` (string|array, opcional) - Filtrar por qualidade (chips selecion√°veis: Economic, Standard, High, Premium)
- `search` (string, opcional) - Busca textual em descri√ß√£o e marca (campo de busca no topo)
- `sort_by` (string, opcional) - Campo para ordena√ß√£o (created_at, brand, finish, unit_price, description, line_number)
- `sort_order` (string, opcional) - Ordem (asc, desc) - padr√£o: desc
- `page` (integer, opcional) - N√∫mero da p√°gina (padr√£o: 1, fixo 20 itens por p√°gina)

### 3.7 Obter Material Espec√≠fico

**T√≠tulo:** Obter Detalhes de Material Extra√≠do  
**Descri√ß√£o:** Retorna detalhes completos de um material extra√≠do espec√≠fico

**URL e M√©todo HTTP:** `GET /api/materials/extracted/{material}`  
**Par√¢metros da Rota:**

- `material` (integer, obrigat√≥rio) - ID do material extra√≠do

### 3.8 Obter Filtros Dispon√≠veis

**T√≠tulo:** Obter Op√ß√µes de Filtros  
**Descri√ß√£o:** Retorna todos os valores √∫nicos dispon√≠veis para filtros (marcas, tipos, acabamentos, etc.)

**URL e M√©todo HTTP:** `GET /api/materials/filters`  
**Par√¢metros da Rota:** Nenhum

## 4. Requisi√ß√£o Esperada

### 4.1 Upload de PDF

**Headers:**

```
Accept: application/json
Content-Type: multipart/form-data
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:**

```
pdf: [arquivo PDF] // Arquivo PDF (obrigat√≥rio, m√°ximo 25MB, apenas .pdf)
```

**Valida√ß√µes:**

- Arquivo obrigat√≥rio
- Apenas tipo MIME `application/pdf`
- Tamanho m√°ximo: 25MB (25.600 KB)
- Apenas pre√ßos em USD ($) s√£o aceitos
- Rejeita documentos com moedas n√£o-USD (R$, ‚Ç¨, ¬£, etc.)
- **Campo `user_id` obrigat√≥rio** (preenchido automaticamente)
- **Autentica√ß√£o obrigat√≥ria** via Bearer Token
- **Valida√ß√£o de ownership** do usu√°rio

### 3.2 Listar Uploads

**Headers:**

```
Accept: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:** Nenhum

### 3.3 Verificar Status

**Headers:**

```
Accept: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:** Nenhum

### 3.4 Atualizar Upload

**Headers:**

```
Accept: application/json
Content-Type: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:**

```json
{
  "display_name": "Or√ßamento Atualizado - Casa Maria Silva" // Nome de exibi√ß√£o (obrigat√≥rio)
}
```

### 3.5 Excluir Upload

**Headers:**

```
Accept: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:** Nenhum

### 3.6 Listar Materiais Extra√≠dos

**Headers:**

```
Accept: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:** Nenhum

**Exemplos de Uso dos Filtros:**

**1. Filtrar por marca espec√≠fica (dropdown):**

```
GET /api/materials/extracted?brand=Benjamin Moore
# Encontra apenas materiais da marca "Benjamin Moore"
```

**2. Filtrar por ambiente/categoria (dropdown):**

```
GET /api/materials/extracted?ambient=Exterior
# Encontra apenas materiais para uso exterior
```

**3. Filtrar por acabamento (dropdown):**

```
GET /api/materials/extracted?finish=Flat
# Encontra apenas materiais com acabamento "Flat"
```

**4. Filtrar por qualidade √∫nica (chip selecionado):**

```
GET /api/materials/extracted?quality=Premium
# Encontra apenas materiais de qualidade "Premium"
```

**5. Filtrar por m√∫ltiplas qualidades (m√∫ltiplos chips):**

```
GET /api/materials/extracted?quality[]=Premium&quality[]=High
# Encontra materiais de qualidade "Premium" OU "High"
```

**6. Busca textual (campo search no topo):**

```
GET /api/materials/extracted?search=interior paint
# Busca "interior paint" na descri√ß√£o e marca
```

**7. M√∫ltiplos filtros combinados:**

```
GET /api/materials/extracted?brand=Benjamin Moore&ambient=Interior&finish=Satin&quality[]=Premium&quality[]=High&search=paint&sort_by=unit_price&sort_order=asc&page=1
```

**9. Navega√ß√£o entre p√°ginas:**

```
# Primeira p√°gina (padr√£o)
GET /api/materials/extracted?page=1

# Segunda p√°gina
GET /api/materials/extracted?page=2

# Terceira p√°gina com filtros
GET /api/materials/extracted?brand=Benjamin Moore&finish=Satin&page=3
```

**8. Ordena√ß√£o personalizada:**

```
# Ordenar por pre√ßo (menor para maior)
GET /api/materials/extracted?sort_by=unit_price&sort_order=asc

# Ordenar por marca (A-Z)
GET /api/materials/extracted?sort_by=brand&sort_order=asc

# Ordenar por acabamento (A-Z)
GET /api/materials/extracted?sort_by=finish&sort_order=asc
```

### 3.7 Obter Material Espec√≠fico

**Headers:**

```
Accept: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:** Nenhum

### 3.8 Obter Filtros Dispon√≠veis

**Headers:**

```
Accept: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:** Nenhum

## 4. Respostas Esperadas

### 4.1 Upload de PDF

**Status 201 (Created):**

```json
{
  "success": true,
  "data": {
    "upload": {
      "id": 15,
      "user_id": 1,
      "original_name": "quote-materials.pdf",
      "file_path": "pdfs/2025/08/27/uuid-quote-materials.pdf",
      "r2_url": "https://cdn.example.com/pdfs/2025/08/27/uuid-quote-materials.pdf",
      "file_hash": "a1b2c3d4e5f6...",
      "status": "pending",
      "materials_extracted": 0,
      "created_at": "2025-08-27T16:30:00Z",
      "updated_at": "2025-08-27T16:30:00Z"
    },
    "message": "PDF uploaded successfully. Processing started.",
    "r2_url": "https://cdn.example.com/pdfs/2025/08/27/uuid-quote-materials.pdf",
    "size": 1048576
  }
}
```

**Status 422 (Validation Error):**

```json
{
  "message": "The PDF field is required.",
  "errors": {
    "pdf": ["The PDF field is required."]
  }
}
```

**Status 422 (File Size Error):**

```json
{
  "message": "The PDF must not exceed 25MB.",
  "errors": {
    "pdf": ["The PDF must not exceed 25MB."]
  }
}
```

**Status 422 (Invalid File Type):**

```json
{
  "message": "The PDF must be a valid PDF file.",
  "errors": {
    "pdf": ["The PDF must be a valid PDF file."]
  }
}
```

**Status 422 (Invalid Currency):**

```json
{
  "success": false,
  "message": "Upload failed: Invalid currency detected: Brazilian Real (R$). Only USD ($) is supported for material pricing."
}
```

**Status 200 (Duplicate File - Already Processed):**

```json
{
  "success": true,
  "data": {
    "upload": {
      "id": 12,
      "original_name": "quote-materials.pdf",
      "file_path": "pdfs/2025/08/27/uuid-quote-materials.pdf",
      "r2_url": "https://cdn.example.com/pdfs/2025/08/27/uuid-quote-materials.pdf",
      "status": "completed",
      "materials_extracted": 25
    },
    "message": "File already uploaded and processed"
  }
}
```

### 4.2 Listar Uploads

**Status 200 (Success):**

```json
{
  "success": true,
  "data": {
    "uploads": [
      {
        "id": 15,
        "original_name": "quote-materials.pdf",
        "display_name": "Quote Materials - Project Alpha",
        "file_path": "pdfs/2025/08/27/uuid-quote-materials.pdf",
        "r2_url": "https://cdn.example.com/pdfs/2025/08/27/uuid-quote-materials.pdf",
        "status": "completed",
        "materials_extracted": 25,
        "created_at": "2025-08-27T16:30:00Z",
        "updated_at": "2025-08-27T16:45:00Z"
      },
      {
        "id": 14,
        "original_name": "paint-list.pdf",
        "display_name": "Premium Paint List",
        "file_path": "pdfs/2025/08/27/uuid-paint-list.pdf",
        "r2_url": "https://cdn.example.com/pdfs/2025/08/27/uuid-paint-list.pdf",
        "status": "processing",
        "materials_extracted": 0,
        "created_at": "2025-08-27T15:15:00Z",
        "updated_at": "2025-08-27T15:20:00Z"
      }
    ],
    "pagination": {
      "total": 45,
      "per_page": 15,
      "current_page": 1,
      "last_page": 3
    }
  }
}
```

### 4.3 Verificar Status

**Status 200 (Success) - Processamento Conclu√≠do:**

```json
{
  "success": true,
  "data": {
    "upload": {
      "id": 15,
      "original_name": "quote-materials.pdf",
      "display_name": "Quote Materials - Project Alpha",
      "file_path": "pdfs/2025/08/27/uuid-quote-materials.pdf",
      "r2_url": "https://cdn.example.com/pdfs/2025/08/27/uuid-quote-materials.pdf",
      "status": "completed",
      "materials_extracted": 25,
      "error_message": null,
      "r2_key": "pdfs/2025/08/27/uuid-quote-materials.pdf",
      "extraction_metadata": {
        "brand": "Sherwin-Williams",
        "total_materials": 25,
        "extraction_timestamp": "2025-08-27T16:45:00Z"
      },
      "created_at": "2025-08-27T16:30:00Z",
      "updated_at": "2025-08-27T16:45:00Z"
    }
  }
}
```

**Status 200 (Success) - Processamento em Andamento:**

```json
{
  "success": true,
  "data": {
    "upload": {
      "id": 14,
      "original_name": "paint-list.pdf",
      "display_name": "Premium Paint List",
      "file_path": "pdfs/2025/08/27/uuid-paint-list.pdf",
      "r2_url": "https://cdn.example.com/pdfs/2025/08/27/uuid-paint-list.pdf",
      "status": "processing",
      "materials_extracted": 0,
      "error_message": null,
      "r2_key": "pdfs/2025/08/27/uuid-paint-list.pdf",
      "created_at": "2025-08-27T15:15:00Z",
      "updated_at": "2025-08-27T16:50:00Z"
    }
  }
}
```

**Status 200 (Success) - Processamento com Erro:**

```json
{
  "success": true,
  "data": {
    "upload": {
      "id": 13,
      "original_name": "corrupted-file.pdf",
      "display_name": "Problematic File",
      "file_path": "pdfs/2025/08/27/uuid-corrupted-file.pdf",
      "r2_url": "https://cdn.example.com/pdfs/2025/08/27/uuid-corrupted-file.pdf",
      "status": "error",
      "materials_extracted": 0,
      "error_message": "Invalid currency detected: Brazilian Real (R$). Only USD ($) is supported for material pricing.",
      "r2_key": "pdfs/2025/08/27/uuid-corrupted-file.pdf",
      "created_at": "2025-08-27T14:00:00Z",
      "updated_at": "2025-08-27T14:05:00Z"
    }
  }
}
```

**Status 404 (Not Found):**

```json
{
  "success": false,
  "message": "Failed to retrieve status: No query results for model [App\\PdfUpload]."
}
```

### 4.4 Atualizar Upload

**Status 200 (Success):**

```json
{
  "success": true,
  "data": {
    "upload": {
      "id": 15,
      "original_name": "quote-materials.pdf",
      "display_name": "Updated Quote - Project Alpha",
      "file_path": "pdfs/2025/08/27/uuid-quote-materials.pdf",
      "r2_url": "https://cdn.example.com/pdfs/2025/08/27/uuid-quote-materials.pdf",
      "status": "completed",
      "updated_at": "2025-08-27T17:00:00Z"
    },
    "message": "PDF display name updated successfully"
  }
}
```

**Status 422 (Validation Error):**

```json
{
  "message": "The display name field is required.",
  "errors": {
    "display_name": ["The display name field is required."]
  }
}
```

**Status 404 (Not Found):**

```json
{
  "success": false,
  "message": "Failed to update PDF: No query results for model [App\\PdfUpload]."
}
```

### 4.5 Excluir Upload

**Status 200 (Success):**

```json
{
  "success": true,
  "data": {
    "message": "PDF and all related materials deleted successfully"
  }
}
```

**Status 404 (Not Found):**

```json
{
  "success": false,
  "message": "Failed to delete PDF: No query results for model [App\\PdfUpload]."
}
```

**Status 422 (Server Error):**

```json
{
  "success": false,
  "message": "Failed to delete PDF: [error details]"
}
```

### 4.6 Listar Materiais Extra√≠dos

**Status 200 (Success):**

```json
{
  "success": true,
  "data": {
    "materials": [
      {
        "id": 15,
        "pdf_upload_id": 3,
        "user_id": 1,
        "brand": "Sherwin-Williams",
        "description": "ProClassic Interior Acrylic Latex Enamel",
        "type": "liquid",
        "unit": "gallon",
        "unit_price": 52.99,
        "finish": "satin",
        "quality_grade": "premium",
        "category": "interior-paint",
        "specifications": {
          "coverage": "350-400 sq ft per gallon",
          "dry_time": "2-4 hours",
          "voc_content": "<50 g/L"
        },
        "line_number": 3,
        "created_at": "2025-08-27T16:45:00Z",
        "updated_at": "2025-08-27T16:45:00Z",
        "pdf_upload": {
          "id": 3,
          "original_name": "sherwin-quote.pdf",
          "display_name": "Sherwin Williams Quote - Living Room",
          "created_at": "2025-08-27T16:30:00Z"
        }
      },
      {
        "id": 16,
        "pdf_upload_id": 3,
        "user_id": 1,
        "brand": "Benjamin Moore",
        "description": "Advance Waterborne Interior Alkyd Paint",
        "type": "liquid",
        "unit": "quart",
        "unit_price": 28.99,
        "finish": "semi-gloss",
        "quality_grade": "professional",
        "category": "trim-paint",
        "specifications": {
          "coverage": "75-100 sq ft per quart",
          "dry_time": "1-2 hours",
          "durability": "high"
        },
        "line_number": 7,
        "created_at": "2025-08-27T16:45:00Z",
        "updated_at": "2025-08-27T16:45:00Z",
        "pdf_upload": {
          "id": 3,
          "original_name": "sherwin-quote.pdf",
          "display_name": "Sherwin Williams Quote - Living Room",
          "created_at": "2025-08-27T16:30:00Z"
        }
      }
    ],
    "pagination": {
      "total": 125,
      "per_page": 20,
      "current_page": 1,
      "last_page": 7,
      "from": 1,
      "to": 20
    },
    "filters_applied": {
      "brand": "Benjamin Moore",
      "ambient": "Interior",
      "finish": "Satin",
      "quality": ["Premium"]
    }
  }
}
```

**Status 422 (Error):**

```json
{
  "success": false,
  "message": "Failed to retrieve materials: [error details]"
}
```

### 4.7 Obter Material Espec√≠fico

**Status 200 (Success):**

```json
{
  "success": true,
  "data": {
    "material": {
      "id": 15,
      "pdf_upload_id": 3,
      "user_id": 1,
      "brand": "Sherwin-Williams",
      "description": "ProClassic Interior Acrylic Latex Enamel",
      "type": "liquid",
      "unit": "gallon",
      "unit_price": 52.99,
      "finish": "satin",
      "quality_grade": "premium",
      "category": "interior-paint",
      "specifications": {
        "coverage": "350-400 sq ft per gallon",
        "dry_time": "2-4 hours",
        "voc_content": "<50 g/L",
        "color_family": "white",
        "sheen_level": "25-35%"
      },
      "line_number": 3,
      "created_at": "2025-08-27T16:45:00Z",
      "updated_at": "2025-08-27T16:45:00Z",
      "pdf_upload": {
        "id": 3,
        "original_name": "sherwin-quote.pdf",
        "display_name": "Sherwin Williams Quote - Living Room",
        "created_at": "2025-08-27T16:30:00Z"
      }
    }
  }
}
```

**Status 404 (Not Found):**

```json
{
  "success": false,
  "message": "Failed to retrieve material: No query results for model [App\\ExtractedMaterial]."
}
```

### 4.8 Obter Filtros Dispon√≠veis

**Status 200 (Success):**

```json
{
  "success": true,
  "data": {
    "filters": {
      "brands": ["Benjamin Moore", "Sherwin-Williams"],
      "ambients": ["Interior", "Exterior"],
      "finishes": ["Flat", "Satin", "Semi-Gloss", "Gloss"],
      "qualities": ["Economic", "Standard", "High", "Premium"]
    }
  }
}
```

**Status 422 (Error):**

```json
{
  "success": false,
  "message": "Failed to retrieve filters: [error details]"
}
```

## 5. Configura√ß√£o do Cloudflare R2

### 5.1 Vari√°veis de Ambiente

Adicione ao `.env`:

```env
# Cloudflare R2 Storage Configuration
R2_ACCESS_KEY_ID=your_r2_access_key_id
R2_SECRET_ACCESS_KEY=your_r2_secret_access_key
R2_ACCOUNT_ID=your_cloudflare_account_id
R2_BUCKET=your_r2_bucket_name
R2_ENDPOINT=https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com
R2_REGION=auto
R2_PUBLIC_BASE_URL=https://your-custom-domain.com
```

### 5.2 Estrutura de Armazenamento

**Formato da Chave R2:**

```
pdfs/{year}/{month}/{day}/{uuid}-{sanitized-filename}.pdf
```

**Exemplo:**

```
pdfs/2025/08/27/03aa1e55-fcc2-47e4-be98-5346dc76ba05-quote-materials.pdf
```

### 5.3 URLs de Acesso

- **URL Tempor√°ria (Privada)**: V√°lida por 15 minutos para buckets privados
- **URL P√∫blica (CDN)**: Via dom√≠nio personalizado quando `R2_PUBLIC_BASE_URL` configurado

### 5.4 Funcionalidades do Sistema

- ‚úÖ **Armazenamento Duplo**: R2 (permanente) + Local (tempor√°rio para processamento)
- ‚úÖ **Detec√ß√£o de Duplicatas**: Baseada em hash MD5 do arquivo
- ‚úÖ **Valida√ß√£o de Moeda**: Apenas USD aceito, rejeita R$, ‚Ç¨, ¬£, etc.
- ‚úÖ **Mensagens em Ingl√™s**: Logs, valida√ß√µes, e respostas API
- ‚úÖ **Sanitiza√ß√£o de Nomes**: Remove caracteres especiais
- ‚úÖ **Organiza√ß√£o Temporal**: Estrutura de pastas por data
- ‚úÖ **Cleanup Autom√°tico**: Remove arquivos locais ap√≥s processamento
- ‚úÖ **Marca Suportadas**: Sherwin-Williams e Benjamin Moore

## 9. Exemplos de Implementa√ß√£o Flutter

### 9.1 Classe Dart para Requisi√ß√µes

```dart
class MaterialFilters {
  String? brand;        // Dropdown: marca espec√≠fica
  String? ambient;      // Dropdown: Interior, Exterior, etc.
  String? finish;       // Dropdown: Flat, Satin, Semi-Gloss, Gloss
  List<String>? quality; // Chips: Economic, Standard, High, Premium (m√∫ltiplo)
  String? search;       // Campo de busca textual
  String sortBy;        // Ordena√ß√£o
  String sortOrder;     // Dire√ß√£o da ordena√ß√£o
  int page;             // P√°gina atual (fixo 20 itens por p√°gina)

  MaterialFilters({
    this.brand,
    this.ambient,
    this.finish,
    this.quality,
    this.search,
    this.sortBy = 'created_at',
    this.sortOrder = 'desc',
    this.page = 1,
  });

  Map<String, dynamic> toQueryParams() {
    final params = <String, dynamic>{};

    if (brand != null && brand!.isNotEmpty) params['brand'] = brand;
    if (ambient != null && ambient!.isNotEmpty) params['ambient'] = ambient;
    if (finish != null && finish!.isNotEmpty) params['finish'] = finish;
    if (search != null && search!.isNotEmpty) params['search'] = search;

    // Qualidade pode ser m√∫ltipla (array)
    if (quality != null && quality!.isNotEmpty) {
      if (quality!.length == 1) {
        params['quality'] = quality!.first;
      } else {
        for (int i = 0; i < quality!.length; i++) {
          params['quality[]'] = quality![i];
        }
      }
    }

    params['sort_by'] = sortBy;
    params['sort_order'] = sortOrder;
    params['page'] = page.toString();

    return params;
  }
}
```

### 9.2 Exemplos de Uso no Flutter

```dart
// 1. Buscar tintas Benjamin Moore com acabamento Satin
final filters = MaterialFilters(
  brand: 'Benjamin Moore',
  finish: 'Satin',
  ambient: 'Interior'
);

final materials = await apiClient.getMaterials(filters);

// 2. Buscar materiais Premium ou High qualidade
final qualityFilters = MaterialFilters(
  quality: ['Premium', 'High'],
  sortBy: 'unit_price',
  sortOrder: 'asc'
);

// 3. Busca textual por "interior paint" - p√°gina 2
final searchFilters = MaterialFilters(
  search: 'interior paint',
  page: 2
);

// 4. Filtros combinados da interface
final combinedFilters = MaterialFilters(
  brand: 'Benjamin Moore',
  ambient: 'Exterior',
  finish: 'Flat',
  quality: ['Premium'],
  search: 'EG-SHEL',
  sortBy: 'brand',
  sortOrder: 'asc'
);
```

### 9.3 Constru√ß√£o de URLs

```dart
String buildMaterialsUrl(MaterialFilters filters) {
  final baseUrl = 'https://paintpro.barbatech.company/api/materials/extracted';
  final params = filters.toQueryParams();

  if (params.isEmpty) return baseUrl;

  final queryString = params.entries
      .map((e) => '${Uri.encodeComponent(e.key)}=${Uri.encodeComponent(e.value)}')
      .join('&');

  return '$baseUrl?$queryString';
}

// Exemplo de URL gerada:
// https://paintpro.barbatech.company/api/materials/extracted?brand=Benjamin Moore&ambient=Interior&finish=Satin&quality[]=Premium&quality[]=High&sort_by=unit_price&sort_order=asc&page=2
```

### 9.4 Filtros Din√¢micos com Dropdown

```dart
// 1. Primeiro, buscar op√ß√µes dispon√≠veis para filtros
final filterOptions = await apiClient.getFilterOptions();

// 2. Popular dropdowns conforme a interface
Widget buildBrandDropdown() {
  return DropdownButton<String>(
    value: selectedBrand,
    hint: Text('Brand'),
    items: filterOptions.brands.map((brand) {
      return DropdownMenuItem(value: brand, child: Text(brand));
    }).toList(),
    onChanged: (value) {
      setState(() => selectedBrand = value);
      applyFilters();
    },
  );
}

Widget buildAmbientDropdown() {
  return DropdownButton<String>(
    value: selectedAmbient,
    hint: Text('Ambient'),
    items: filterOptions.ambients.map((ambient) {
      return DropdownMenuItem(value: ambient, child: Text(ambient));
    }).toList(),
    onChanged: (value) {
      setState(() => selectedAmbient = value);
      applyFilters();
    },
  );
}

Widget buildFinishDropdown() {
  return DropdownButton<String>(
    value: selectedFinish,
    hint: Text('Finish'),
    items: filterOptions.finishes.map((finish) {
      return DropdownMenuItem(value: finish, child: Text(finish));
    }).toList(),
    onChanged: (value) {
      setState(() => selectedFinish = value);
      applyFilters();
    },
  );
}

// 3. Chips de qualidade (sele√ß√£o m√∫ltipla)
Widget buildQualityChips() {
  return Wrap(
    spacing: 8.0,
    children: filterOptions.qualities.map((quality) {
      final isSelected = selectedQualities.contains(quality);
      return FilterChip(
        label: Text(quality),
        selected: isSelected,
        onSelected: (selected) {
          setState(() {
            if (selected) {
              selectedQualities.add(quality);
            } else {
              selectedQualities.remove(quality);
            }
          });
          applyFilters();
        },
      );
    }).toList(),
  );
}

// 4. Aplicar filtros quando mudarem
void applyFilters() {
  final filters = MaterialFilters(
    brand: selectedBrand,
    ambient: selectedAmbient,
    finish: selectedFinish,
    quality: selectedQualities.isEmpty ? null : selectedQualities,
    search: searchController.text.isEmpty ? null : searchController.text,
  );

  // Recarregar lista
  loadMaterials(filters);
}

// 5. Implementa√ß√£o de pagina√ß√£o
class MaterialsPagination {
  int currentPage = 1;
  int? totalPages;
  bool isLoading = false;

  // Carregar pr√≥xima p√°gina
  void loadNextPage() {
    if (totalPages != null && currentPage < totalPages! && !isLoading) {
      currentPage++;
      final filters = getCurrentFilters();
      filters.page = currentPage;
      loadMaterials(filters);
    }
  }

  // Carregar p√°gina anterior
  void loadPreviousPage() {
    if (currentPage > 1 && !isLoading) {
      currentPage--;
      final filters = getCurrentFilters();
      filters.page = currentPage;
      loadMaterials(filters);
    }
  }

  // Ir para p√°gina espec√≠fica
  void goToPage(int page) {
    if (page >= 1 && (totalPages == null || page <= totalPages!) && !isLoading) {
      currentPage = page;
      final filters = getCurrentFilters();
      filters.page = page;
      loadMaterials(filters);
    }
  }

  // Widget de pagina√ß√£o
  Widget buildPagination() {
    if (totalPages == null || totalPages! <= 1) return SizedBox.shrink();

    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        IconButton(
          onPressed: currentPage > 1 ? loadPreviousPage : null,
          icon: Icon(Icons.chevron_left),
        ),
        Text('P√°gina $currentPage de $totalPages'),
        IconButton(
          onPressed: currentPage < totalPages! ? loadNextPage : null,
          icon: Icon(Icons.chevron_right),
        ),
      ],
    );
  }
}
```

## 7. Melhorias de Seguran√ßa Implementadas

### 7.1 Migra√ß√£o de Seguran√ßa

- **Campo `user_id` obrigat√≥rio** - Migra√ß√£o executada para tornar NOT NULL
- **Limpeza de registros √≥rf√£os** - Remo√ß√£o de PDFs sem usu√°rio associado
- **Integridade referencial** - Garantia de que todos os PDFs tenham usu√°rio

### 7.2 Pol√≠ticas de Autoriza√ß√£o

- **PdfUploadPolicy** - Controle de acesso aos PDFs por usu√°rio
- **ExtractedMaterialPolicy** - Controle de acesso aos materiais por usu√°rio
- **Verifica√ß√£o autom√°tica** de ownership em todas as opera√ß√µes

### 7.3 Middleware de Seguran√ßa

- **`pdf.security`** - Valida√ß√£o espec√≠fica para opera√ß√µes de PDF
- **`user.ownership`** - Garantia de ownership de dados
- **Logs de seguran√ßa** para auditoria e monitoramento

### 7.4 Modelos Seguros

- **Global scopes** - Filtros autom√°ticos por usu√°rio
- **Valida√ß√£o autom√°tica** de `user_id` em cria√ß√£o
- **M√©todos de verifica√ß√£o** de propriedade

## 8. Observa√ß√µes T√©cnicas

### 8.1 Processamento

- Arquivo armazenado em R2 imediatamente ap√≥s upload
- Arquivo tempor√°rio local usado apenas para extra√ß√£o de texto
- Job de processamento desabilitado em ambiente de teste
- Suporte a PDF com pre√ßos apenas em USD

### 8.2 Seguran√ßa

- **Autentica√ß√£o obrigat√≥ria** (Laravel Sanctum)
- **Rate limiting aplicado**
- **Valida√ß√£o rigorosa de tipo MIME**
- **Limite de tamanho: 25MB**
- **Campo `user_id` obrigat√≥rio** (NOT NULL)
- **Pol√≠ticas de autoriza√ß√£o** para controle granular
- **Middleware de seguran√ßa** espec√≠fico para PDFs
- **Isolamento autom√°tico por usu√°rio** em todos os modelos
- **Valida√ß√£o de ownership** em todas as opera√ß√µes CRUD
- **Logs de seguran√ßa** para auditoria
- **Preven√ß√£o de acesso n√£o autorizado** a recursos

### 8.3 Performance

- Armazenamento distribu√≠do via Cloudflare R2
- URLs de acesso otimizadas (tempor√°rias ou CDN)
- Processamento ass√≠ncrono via jobs
- Cache de metadados no banco de dados
