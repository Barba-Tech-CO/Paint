# M√ìDULO DE OR√áAMENTOS - ORCAMENTOS_MODULE

## üìå Vis√£o Geral

Respons√°vel por todo o ciclo de or√ßamento de pintura, desde a coleta das fotos at√© o envio final para o CRM. O m√≥dulo combina fluxos manuais (CRUD via API) e automa√ß√µes guiadas pelo Jamie AI.

## üîó Links R√°pidos
- Refer√™ncia de endpoints: `docs/reference/estimates.md`
- Fluxo Jamie AI (one-shot estimate): `docs/reference/jamie-ai.md`
- Materiais e PDFs relacionados: `docs/reference/materials.md`
- Cole√ß√£o Postman (`/Estimates`): `docs/collections/api-postman.json`

## üß± Componentes Principais
- **Modelo `Estimate`** ‚Äì Entidade central com status de workflow e dados agregados.
- **Enums e Policies** ‚Äì Garantem transi√ß√µes v√°lidas de status e isolamento por usu√°rio.
- **Processador de fotos & IA** ‚Äì Normaliza fotos, alimenta o Jamie AI e atualiza campos autom√°ticos.
- **Integra√ß√£o GHL** ‚Äì Sincroniza or√ßamentos aprovados com o pipeline de vendas.

## 1. Modelos de Dados e Estrutura da Tabela

### Modelo Estimate (Or√ßamento)

**Arquivo:** `app/Modules/PaintPro/Models/Estimate.php`

**Atributos do Model:**
- `id` (integer, not null) - ID √∫nico do or√ßamento
- `user_id` (integer, nullable) - ID do usu√°rio propriet√°rio
- `ghl_estimate_id` (string, nullable) - ID do or√ßamento no GoHighLevel
- `ghl_contact_id` (string, nullable) - ID do contato no GoHighLevel
- `contact` (string, not null) - ID do contato (obrigat√≥rio)
- `project_name` (string, nullable) - Nome do projeto
- `client_name` (string, nullable) - Nome do cliente
- `project_type` (enum, nullable) - Tipo do projeto (interior, exterior, both)
- `additional_notes` (text, nullable) - Notas adicionais
- `status` (enum, not null) - Status do or√ßamento (draft, photos_uploaded, elements_selected, materials_calculated, completed, sent)
- `photos_data` (array, nullable) - Dados das fotos
- `measurements` (array, nullable) - Medidas dos c√¥modos
- `paint_elements` (array, nullable) - Elementos selecionados para pintura
- `wall_condition` (enum, not null) - Condi√ß√£o da parede (very_good, good, poor, very_poor)
- `has_accent_wall` (boolean, not null) - Possui parede de destaque
- `extra_notes` (text, nullable) - Notas extras
- `materials_calculation` (array, nullable) - C√°lculo de materiais
- `labor_calculation` (array, nullable) - C√°lculo de m√£o de obra
- `total_cost` (decimal, not null) - Custo total
- `complete` (boolean, not null) - Projeto marcado como completo
- `estimated_timeline_days` (integer, nullable) - Prazo estimado em dias
- `ghl_folder_name` (string, nullable) - Nome da pasta no GHL
- `photos_uploaded_at` (timestamp, nullable) - Data do upload das fotos
- `measurements_completed_at` (timestamp, nullable) - Data da conclus√£o das medidas
- `sent_to_client_at` (timestamp, nullable) - Data de envio ao cliente
- `created_at` (timestamp, not null) - Data de cria√ß√£o
- `updated_at` (timestamp, not null) - Data de atualiza√ß√£o

**Estrutura da Tabela `estimates`:**
```sql
CREATE TABLE estimates (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NULL,
    ghl_estimate_id VARCHAR(255) NULL,
    ghl_contact_id VARCHAR(255) NULL,
    contact VARCHAR(255) NOT NULL,
    project_name VARCHAR(255) NULL,
    client_name VARCHAR(255) NULL,
    project_type ENUM('interior', 'exterior', 'both') NULL,
    additional_notes TEXT NULL,
    status ENUM('draft', 'photos_uploaded', 'photos_processed', 'elements_selected', 'materials_calculated', 'completed', 'sent') DEFAULT 'draft',
    photos_data JSON NULL,
    zones JSON NULL,
    measurements JSON NULL,
    paint_elements JSON NULL,
    wall_condition ENUM('very_good', 'good', 'poor', 'very_poor') NOT NULL,
    has_accent_wall BOOLEAN DEFAULT FALSE,
    extra_notes TEXT NULL,
    materials_calculation JSON NULL,
    materials JSON NULL,
    totals JSON NULL,
    labor_calculation JSON NULL,
    total_cost DECIMAL(10,2) NOT NULL,
    complete BOOLEAN DEFAULT FALSE,
    estimated_timeline_days INT NULL,
    ghl_folder_name VARCHAR(255) NULL,
    photos_uploaded_at TIMESTAMP NULL,
    measurements_completed_at TIMESTAMP NULL,
    sent_to_client_at TIMESTAMP NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    INDEX idx_ghl_estimate (ghl_estimate_id),
    INDEX idx_ghl_contact (ghl_contact_id),
    INDEX idx_client_project (client_name, project_name),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

### Enum EstimateStatus (Status do Or√ßamento)

**Arquivo:** `app/Modules/Shared/Enums/EstimateStatus.php`

**Valores Poss√≠veis:**
- `DRAFT` - Rascunho
- `PHOTOS_UPLOADED` - Fotos carregadas
- `PHOTOS_PROCESSED` - Fotos processadas
- `ELEMENTS_SELECTED` - Elementos selecionados
- `MATERIALS_CALCULATED` - Materiais calculados
- `COMPLETED` - Conclu√≠do
- `SENT` - Enviado ao cliente

## 2. Endpoints da API

### 2.1 Listar Or√ßamentos

**T√≠tulo:** Listar Todos os Or√ßamentos  
**Descri√ß√£o:** Retorna uma lista paginada de or√ßamentos com op√ß√µes de filtro

**URL e M√©todo HTTP:** `GET /api/estimates`  
**Par√¢metros da Rota:** Nenhum  
**Query Parameters:**
- `client_name` (string, opcional) - Filtrar por nome do cliente
- `project_type` (string, opcional) - Filtrar por tipo de projeto (interior, exterior, both)
- `status` (string, opcional) - Filtrar por status do or√ßamento
- `search` (string, opcional) - Busca geral em nome do cliente, projeto e tipo
- `limit` (integer, opcional) - N√∫mero de itens por p√°gina (min: 1, max: 100, padr√£o: 15)

### 2.2 Obter Dashboard

**T√≠tulo:** Dashboard de Estat√≠sticas  
**Descri√ß√£o:** Retorna estat√≠sticas e m√©tricas dos or√ßamentos

**URL e M√©todo HTTP:** `GET /api/estimates/dashboard`  
**Par√¢metros da Rota:** Nenhum

### 2.3 Obter Or√ßamento

**T√≠tulo:** Obter Or√ßamento por ID  
**Descri√ß√£o:** Retorna dados detalhados de um or√ßamento espec√≠fico

**URL e M√©todo HTTP:** `GET /api/estimates/{id}`  
**Par√¢metros da Rota:**
- `id` (integer, obrigat√≥rio) - ID do or√ßamento

### 2.4 Criar Or√ßamento

**T√≠tulo:** Criar Novo Or√ßamento  
**Descri√ß√£o:** Cria um novo or√ßamento de pintura

**URL e M√©todo HTTP:** `POST /api/estimates`  
**Par√¢metros da Rota:** Nenhum

### 2.5 Atualizar Or√ßamento

**T√≠tulo:** Atualizar Or√ßamento  
**Descri√ß√£o:** Atualiza dados de um or√ßamento existente

**URL e M√©todo HTTP:** `PUT /api/estimates/{id}`  
**Par√¢metros da Rota:**
- `id` (integer, obrigat√≥rio) - ID do or√ßamento

### 2.6 Excluir Or√ßamento

**T√≠tulo:** Excluir Or√ßamento  
**Descri√ß√£o:** Remove um or√ßamento do sistema

**URL e M√©todo HTTP:** `DELETE /api/estimates/{id}`  
**Par√¢metros da Rota:**
- `id` (integer, obrigat√≥rio) - ID do or√ßamento

## 3. Requisi√ß√£o Esperada

### 3.1 Listar Or√ßamentos

**Headers:**
```
Accept: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:** Nenhum

### 3.2 Obter Dashboard

**Headers:**
```
Accept: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:** Nenhum

### 3.3 Obter Or√ßamento

**Headers:**
```
Accept: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:** Nenhum

### 3.4 Criar Or√ßamento

**Headers:**
```
Accept: application/json
Content-Type: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:**
```json
{
    "contact": "60d5ec49e1b2c50012345678", // ID do contato (obrigat√≥rio)
    "project_name": "Casa da Maria - Pintura Externa", // Nome do projeto (opcional)
    "client_name": "Maria Silva", // Nome do cliente (opcional)
    "project_type": "exterior", // Tipo do projeto (opcional: interior, exterior, both)
    "additional_notes": "Cliente prefere tintas ecol√≥gicas", // Notas adicionais (opcional)
    "wall_condition": "good", // Condi√ß√£o da parede (obrigat√≥rio: very_good, good, poor, very_poor)
    "has_accent_wall": false, // Possui parede de destaque (opcional, padr√£o: false)
    "extra_notes": "Acesso dif√≠cil na parede dos fundos", // Notas extras (opcional)
    "measurements": [ // Medidas dos c√¥modos (opcional)
        {
            "room": "living_room",
            "area": 25.5
        },
        {
            "room": "bedroom",
            "area": 15.0
        }
    ],
    "paint_elements": [ // Elementos para pintura (opcional)
        {
            "type": "wall",
            "description": "Parede externa frontal",
            "area": 25.5
        }
    ],
    "total_cost": 405.50 // Custo total (obrigat√≥rio)
}
```

### 3.5 Atualizar Or√ßamento

**Headers:**
```
Accept: application/json
Content-Type: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:**
```json
{
    "project_name": "Casa da Maria - Pintura Completa", // Nome do projeto (opcional)
    "client_name": "Maria Silva Santos", // Nome do cliente (opcional)
    "project_type": "both", // Tipo do projeto (opcional)
    "additional_notes": "Cliente quer cores neutras", // Notas adicionais (opcional)
    "status": "materials_calculated", // Status (opcional)
    "wall_condition": "good", // Condi√ß√£o da parede (opcional)
    "has_accent_wall": true, // Possui parede de destaque (opcional)
    "extra_notes": "Parede de destaque na sala", // Notas extras (opcional)
    "measurements": [ // Medidas atualizadas (opcional)
        {
            "room": "living_room",
            "area": 30.0
        }
    ],
    "materials_calculation": { // C√°lculo de materiais (opcional)
        "gallons_needed": 3.5,
        "cans_needed": 4,
        "unit": "gallon",
        "total_cost": 175.00
    },
    "labor_calculation": { // C√°lculo de m√£o de obra (opcional)
        "hours_needed": 12,
        "hourly_rate": 35.00,
        "total_cost": 420.00
    },
    "total_cost": 595.00, // Custo total atualizado (opcional)
    "estimated_timeline_days": 4 // Prazo estimado (opcional)
}
```

### 3.6 Excluir Or√ßamento

**Headers:**
```
Accept: application/json
Authorization: Bearer {auth_token}
```

**Corpo da Requisi√ß√£o:** Nenhum

## 4. Respostas Esperadas

### 4.1 Listar Or√ßamentos

**Status 200 (Success):**
```json
{
    "data": [
        {
            "id": 1,
            "contact": "60d5ec49e1b2c50012345678",
            "project_name": "Casa da Maria - Pintura Externa",
            "client_name": "Maria Silva",
            "project_type": "exterior",
            "status": "completed",
            "total_cost": "405.50",
            "estimated_timeline_days": 3,
            "created_at": "2025-01-20T10:00:00Z",
            "updated_at": "2025-01-20T16:00:00Z"
        }
    ],
    "pagination": {
        "total": 25,
        "per_page": 15,
        "current_page": 1,
        "last_page": 2
    }
}
```

**Status 429 (Too Many Requests):**
```json
{
    "error": "rate_limit_exceeded",
    "message": "Limite de requisi√ß√µes excedido"
}
```

### 4.2 Obter Dashboard

**Status 200 (Success):**
```json
{
    "statistics": {
        "total_estimates": 125,
        "completed_estimates": 85,
        "pending_estimates": 25,
        "sent_estimates": 60,
        "total_revenue": "125450.00",
        "average_project_value": "1254.50"
    },
    "recent_estimates": [
        {
            "id": 15,
            "client_name": "Jo√£o Santos",
            "project_name": "Apartamento Copacabana",
            "status": "materials_calculated",
            "total_cost": "850.00",
            "created_at": "2025-01-20T14:30:00Z"
        }
    ],
    "status_breakdown": {
        "draft": 15,
        "photos_uploaded": 8,
        "elements_selected": 12,
        "materials_calculated": 25,
        "completed": 45,
        "sent": 20
    }
}
```

### 4.3 Obter Or√ßamento

**Status 200 (Success):**
```json
{
    "id": 1,
    "user_id": 1,
    "ghl_estimate_id": "est_60d5ec49e1b2c50012345678",
    "ghl_contact_id": "60d5ec49e1b2c50012345678",
    "contact": "60d5ec49e1b2c50012345678",
    "project_name": "Casa da Maria - Pintura Externa",
    "client_name": "Maria Silva",
    "project_type": "exterior",
    "additional_notes": "Cliente prefere tintas ecol√≥gicas",
    "status": "completed",
    "photos_data": [
        "storage/estimates/1/photos/photo1.jpg",
        "storage/estimates/1/photos/photo2.jpg"
    ],
    "measurements": [
        {
            "room": "living_room",
            "area": 25.5
        }
    ],
    "paint_elements": [
        {
            "type": "wall",
            "description": "Parede externa frontal",
            "area": 25.5
        }
    ],
    "wall_condition": "good",
    "has_accent_wall": false,
    "extra_notes": "Acesso dif√≠cil na parede dos fundos",
    "materials_calculation": {
        "gallons_needed": 2.5,
        "cans_needed": 3,
        "unit": "gallon",
        "total_cost": 125.50
    },
    "labor_calculation": {
        "hours_needed": 8,
        "hourly_rate": 35.00,
        "total_cost": 280.00
    },
    "total_cost": "405.50",
    "complete": true,
    "estimated_timeline_days": 3,
    "ghl_folder_name": "casa_maria_silva",
    "photos_uploaded_at": "2025-01-20T14:30:00Z",
    "measurements_completed_at": "2025-01-20T15:45:00Z",
    "sent_to_client_at": "2025-01-20T16:00:00Z",
    "created_at": "2025-01-20T10:00:00Z",
    "updated_at": "2025-01-20T16:00:00Z"
}
```

**Status 404 (Not Found):**
```json
{
    "error": "estimate_not_found",
    "message": "Or√ßamento n√£o encontrado"
}
```

### 4.4 Criar Or√ßamento

**Status 201 (Created):**
```json
{
    "id": 26,
    "contact": "60d5ec49e1b2c50012345678",
    "project_name": "Casa da Maria - Pintura Externa",
    "client_name": "Maria Silva",
    "project_type": "exterior",
    "status": "draft",
    "wall_condition": "good",
    "has_accent_wall": false,
    "total_cost": "405.50",
    "complete": false,
    "created_at": "2025-01-20T17:00:00Z",
    "updated_at": "2025-01-20T17:00:00Z"
}
```

**Status 400 (Bad Request):**
```json
{
    "error": "validation_error",
    "message": "Dados inv√°lidos para cria√ß√£o do or√ßamento",
    "details": {
        "contact": ["O campo contato √© obrigat√≥rio"],
        "wall_condition": ["O campo condi√ß√£o da parede √© obrigat√≥rio"],
        "total_cost": ["O campo custo total √© obrigat√≥rio"]
    }
}
```

**Status 422 (Unprocessable Entity):**
```json
{
    "error": "business_rule_error",
    "message": "Contato especificado n√£o existe ou n√£o est√° ativo"
}
```

### 4.5 Atualizar Or√ßamento

**Status 200 (Success):**
```json
{
    "id": 1,
    "project_name": "Casa da Maria - Pintura Completa",
    "client_name": "Maria Silva Santos",
    "project_type": "both",
    "status": "materials_calculated",
    "total_cost": "595.00",
    "estimated_timeline_days": 4,
    "updated_at": "2025-01-20T17:30:00Z"
}
```

**Status 400 (Bad Request):**
```json
{
    "error": "validation_error",
    "message": "Dados inv√°lidos para atualiza√ß√£o",
    "details": {
        "total_cost": ["O campo custo total deve ser um n√∫mero v√°lido"]
    }
}
```

**Status 404 (Not Found):**
```json
{
    "error": "estimate_not_found",
    "message": "Or√ßamento n√£o encontrado para atualiza√ß√£o"
}
```

**Status 422 (Unprocessable Entity):**
```json
{
    "error": "estimate_not_editable",
    "message": "Or√ßamento n√£o pode ser editado no status atual"
}
```

### 4.6 Excluir Or√ßamento

**Status 200 (Success):**
```json
{
    "success": true,
    "message": "Or√ßamento exclu√≠do com sucesso"
}
```

**Status 404 (Not Found):**
```json
{
    "error": "estimate_not_found",
    "message": "Or√ßamento n√£o encontrado para exclus√£o"
}
```

**Status 409 (Conflict):**
```json
{
    "error": "estimate_in_use",
    "message": "Or√ßamento n√£o pode ser exclu√≠do pois j√° foi enviado ao cliente"
}
```

**Status 500 (Internal Server Error):**
```json
{
    "error": "deletion_error",
    "message": "Erro interno ao excluir or√ßamento"
}
```
